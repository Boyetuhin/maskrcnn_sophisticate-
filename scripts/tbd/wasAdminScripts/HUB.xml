<?xml version="1.0" encoding="iso-8859-1" ?>

<!-- Author: TCS (Tata Consultancy Services)  Limited -->

<!-- Run SetupcmdLine.bat after deployment-->

<project name="HUBv4Deploy" default="install" basedir="./tmp">

	<!-- Defining customized tasks-->
	<!-- Task which will generate the providerURL-->
	<taskdef name="corbaurl" classname="com.tcs.incremental.CorbaTask" classpath="../installUtility.jar" />
	<!-- Task which will give the logMode for application -->
	<taskdef name="logmode" classname="com.tcs.incremental.LogMode" classpath="../installUtility.jar" />
	<!-- Task which will generate the jdbc URL-->
	<taskdef name="dbURLTask" classname="com.tcs.incremental.DBStringTask" classpath="../installUtility.jar" />
	<!-- Task which will encrypt the batch user password-->
	<taskdef name="enctask" classname="com.tcs.ncs.encryption.GetEncryptdPswd" classpath="../installUtility.jar" />
	<!-- Task to unset property -->
	<taskdef name="unset" classname="ise.antelope.tasks.Unset" classpath="../AntelopeTasks_3.2.10.jar" />

	<!-- Specify the Property File to be used -->
	<property file="../was.config.properties" />
	<!-- generating jdbcURL String-->
	<dbURLTask dbAddressString="${dbAddressString}" dbName="${dbName}" dbType="${dbType}" />

	<unset name="dttime" />
	<tstamp>
		<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
	</tstamp>

	<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
	<echo message="${dttime} ************************************************" append="yes" file="../log/Deployment.log" />

	<!-- Main task of the build file-->
	<target name="install" depends="createProviderURL,SyncHUBHOME,BuildFinal">
	</target>
	<target name="prepare" depends="createProviderURL,SyncHUBHOME,BuildFinal">
	</target>
	<!-- Target to Build and Validate the APPHOME-->
	<target name="SyncHUBHOME">
		<echo message="Analysing APPHOME..." />
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>

		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Starting SYNC of HUBHOME ..." append="yes" file="../log/Deployment.log" />
		<copy todir="${appHome}/scripts" overwrite="true">
			<fileset dir="../../scripts" />
		</copy>
		<copy todir="${appHome}/properties" overwrite="true">
			<fileset dir="../../properties" />
		</copy>
		<!--mkdir dir="${appHome}/EAI_GUI_LOGS" />
		<mkdir dir="${appHome}/_temp" />
		<copy todir="${appHome}/install" overwrite="true">
			<fileset dir="../../data/ear" />
		</copy-->
		<mkdir dir="${appHome}/backup" />
		<copy file="../../data/ear/${archiveFileName}" tofile="${appHome}/install/Template_Bancs.ear" overwrite="true">
		</copy>
		<echo message="End of Analysing APPHOME..." />
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} SYNC of HUBHOME Done ..." append="yes" file="../log/Deployment.log" />
	</target>

	<!-- Target to generate the providerURL and logMode-->
	<target name="createProviderURL">
		<echo message="Generating  providerURL..." />
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Generating provider URL ..." append="yes" file="../log/Deployment.log" />
		<corbaurl standalone="${standAloneManagedServerListenAddress}" cluster="${ManagedServersListenAddressList}" portlist="${bootstrapPortList}" deptype="${appDepMode}" />
		<logmode mode="${log_mode}" />
	</target>

	<!-- Target for taking backup -->
	<target name="Backup">
		<echo message="Backing up all contents.." />
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Backing up all contents .." append="yes" file="../log/Deployment.log" />

		<copy file="${appHome}/install/Template_Bancs.ear" tofile="${appHome}/backup/Template_Bancs.ear" overwrite="true">
		</copy>
		<copy file="${appHome}/install/${archiveFileName}" tofile="${appHome}/backup/${archiveFileName}" overwrite="true">
		</copy>
		<copy todir="${appHome}/backup/scripts" overwrite="true">
			<fileset dir="${appHome}/scripts" />
		</copy>
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Backing up done .." append="yes" file="../log/Deployment.log" />
	</target>

	<target name="BuildFinal" depends="extractEar,updateWebXml,updateProps,updateEjbJarXml,BuildEar">
	</target>
	<target name="updateProps">
		<replaceregexp file="EAI_UI/WEB-INF/classes/bcui.properties" match="eai_Home" replace="${appHome}" byline="true" />
		<replaceregexp file="EAI_UI/WEB-INF/classes/Tracer.properties" match="eai_Home" replace="${appHome}" byline="true" />
	</target>
	<!-- extract EAIv4.ear in EAIv4-->
	<target name="extractEar">
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Extracting EAR .." append="yes" file="../log/Deployment.log" />

		<property name="earfilelocation" value="../../data/ear" />
		<copy file="${earfilelocation}/${archiveFileName}" tofile="${archiveFileName}" overwrite="true" />
		<mkdir dir="${appName}" />
		<copy file="${archiveFileName}" tofile="${appName}/${archiveFileName}" overwrite="true" />
		<unzip src="${appName}/${archiveFileName}" dest="${appName}" />
		<delete file="${appName}/${archiveFileName}" />

		<!-- extract EAI_UI.war in EAIv4Web-->
		<mkdir dir="BancsWEB" />
		<copy file="${appName}/BancsWEB.war" tofile="BancsWEB/BancsWEB.war" />
		<unzip src="BancsWEB/BancsWEB.war" dest="BancsWEB" />
		<delete file="BancsWEB/BancsWEB.war" />

		<!-- extract MCAppBEAN.jar in MCAppBEAN-->
		<mkdir dir="BancsEJB" />
		<copy file="${appName}/BancsEJB.jar" tofile="BancsEJB/BancsEJB.jar" />
		<unzip src="BancsEJB/BancsEJB.jar" dest="BancsEJB" />
		<delete file="BancsEJB/BancsEJB.jar" />

		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} EAR Extracted .." append="yes" file="../log/Deployment.log" />

	</target>

	<!-- Make changes in web.xml related to templated values -->
	<target name="updateWebXml">
		<!-- Remove System Identifier from web.xml   -->
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Updating web.xml " append="yes" file="../log/Deployment.log" />

		<replaceregexp file="BancsWEB/WEB-INF/web.xml" match="deploymentDir" replace="${deploymentDir}" byline="true" />
		<replaceregexp file="BancsWEB/WEB-INF/web.xml" match="deploymentDirLog" replace="${deploymentDir}" byline="true" />

	</target>

	<!--Make changes in ejb-jar.xml file of MCraftEJB and application.xml file -->
	<target name="updateEjbJarXml">
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Updating ejb-jar.xml" append="yes" file="../log/Deployment.log" />

		<replaceregexp file="BancsEJB/META-INF/ejb-jar.xml" match="deploymentDir" replace="${deploymentDir}" byline="true" />
		<!--replaceregexp file="BancsEJB/META-INF/ejb-jar.xml" match="dbschema_value" replace="${dbSchemaName}" byline="true" /-->
		<replaceregexp file="${appName}/META-INF/application.xml" match="MMAPPNAME" replace="${appName}" byline="true" />
	</target>


	<!-- Again package the ear in output folder-->
	<target name="BuildEar">
		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} Building EAR" append="yes" file="../log/Deployment.log" />
		<!--Create EAIv4Web WAR-->
		<war destfile="${appName}/BancsWEB.war" webxml="BancsWEB/WEB-INF/web.xml" manifest="BancsWEB/META-INF/MANIFEST.MF" basedir="BancsWEB" />
		<!-- Creates JAR of Utils in localpath/EAR folder -->
		<jar destfile="${appName}/BancsEJB.jar" basedir="BancsEJB" includes="**/**.*" manifest="BancsEJB/META-INF/MANIFEST.MF" />
		<mkdir dir="Output" />
		<!-- Create EAR (EAI_APP.ear) from EAR folder -->
		<ear destfile="Output/${archiveFileName}" appxml="${appName}/META-INF/application.xml">
			<fileset dir="${appName}" />
		</ear>
		<copy file="Output/${archiveFileName}" todir="${appHome}/install/" />
		<move file="Output/${archiveFileName}" todir="../../data/installear/" />
		<delete includeemptydirs="true">
			<fileset dir="BancsWEB" includes="**/*" />
		</delete>
		<delete dir="BancsWEB" />
		<delete includeemptydirs="true">
			<fileset dir="BancsEJB" includes="**/*" />
		</delete>
		<delete dir="BancsEJB" />
		<delete includeemptydirs="true">
			<fileset dir="." includes="**/*" />
		</delete>

		<unset name="dttime" />
		<tstamp>
			<format property="dttime" pattern="dd-MM-yyyy-hh:mm:ss" />
		</tstamp>
		<echo message="${line.separator}" append="yes" file="../log/Deployment.log" />
		<echo message="${dttime} EAR Built" append="yes" file="../log/Deployment.log" />

	</target>


	<!-- Target to Uninstall the Application from the Application Server by calling wsadmins script -->

	<target name="UninstallApp" depends="Backup">
		<echo message=" Beginning Un-Installation..." />
		<mkdir dir="${appHome}/backup/tarBakup" />
		<mkdir dir="${appHome}/backup/tarBakup/data" />
		<mkdir dir="${appHome}/backup/tarBakup/data/ear" />
		<copy file="${appHome}/install/Template_Bancs.ear" tofile="${appHome}/backup/tarBakup/data/ear/${archiveFileName}" overwrite="true" />
		<mkdir dir="${appHome}/backup/tarBakup/scripts" />
		<copy todir="${appHome}/backup/tarBakup/scripts" overwrite="true">
			<fileset dir="${appHome}/scripts" />
		</copy>
		<mkdir dir="${appHome}/backup/tarBakup/properties" />
		<copy todir="${appHome}/backup/tarBakup/properties" overwrite="true">
			<fileset dir="${appHome}/properties" />
		</copy>
		<echo message="Un-Installation Complete ..." />
	</target>

</project>
